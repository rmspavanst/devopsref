---
- block:
  - debug:
      msg: "{{ dr_enable_cron_job }}- Enable the Cron Job in IB App Servers."
  tags:
    - A39.05
    - A39
    - B26

- debug:
    msg: "{{ dr_enable_cron_job }}- Check if the crontab has already been enabled"
  tags:
    - A39.05
    - A39
    - B26
    
- name: "{{ dr_enable_cron_job }}- Query crontab -l status"
  shell: crontab -l | grep -v "^#" | wc -l
  register: cron_stat
  tags:
    - A39.05
    - A39
    - B26

- set_fact:
   cron_disabled: true           
  tags:
    - A39.05
    - A39
    - B26
            
- set_fact:
    cron_disabled: false
  when: cron_stat.stdout | trim != '0'
  tags:
    - A39.05
    - A39
    - B26
        
- debug:
    var: cron_stat.stdout | trim
  tags:
    - A39.05
    - A39
    - B26

- debug:
    var: cron_disabled
  tags:
    - A39.05
    - A39
    - B26

- block:      
  - name: "{{dr_enable_cron_job}}- Backup the cron job "
    shell: 
      cmd: |
        rm /var/spool/cron/crontabs/root.bak.*;
        /usr/bin/crontab -l > /var/spool/cron/crontabs/root.bak.{{lookup('pipe','date +%Y-%m-%dT%H.%M.%S')}}
    register: result
    tags:
      - A39.1

  - debug:
      msg: "{{ dr_enable_cron_job }}- cronjob backup successfully"
      
  - name: "{{dr_enable_cron_job}}- Comment cron job"
    shell: "cat /var/spool/cron/crontabs/root | sed 's/^#//g' > /tmp/1; cp /tmp/1 /var/spool/cron/crontabs/root"  
    tags:
      - A39.1

  - name: "{{dr_enable_cron_job}}- Restart cron job"
    shell:
      cmd: ps -ef | grep cron
    register: cmd
    tags:
      - A39.2

  - set_fact:
      pid_2b_delete: "{{ item }}"
    with_items: "{{ cmd.stdout_lines }}"
    when: not item | regex_search('.*' + 'pts' + '.*')
    tags:
      - A39.2

  - set_fact:
      pid_2b_delete: "{{ pid_2b_delete.split()[1] }}"
    tags:
      - A39.2

  - name: "{{ dr_enable_cron_job }}- Killing the process id {{ pid_2b_delete }}"
    shell:
      cmd: "kill -9 {{ pid_2b_delete }}"
    tags:
      - A39.2
      
  - debug:
      msg: "{{ dr_enable_cron_job }}- cronjob enabled successfully"   
    tags:
      - A39.2
      
  when: cron_disabled == true
  tags:
    - A39
    - B26


